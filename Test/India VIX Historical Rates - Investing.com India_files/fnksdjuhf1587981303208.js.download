"use strict";function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}define("app/modules/LeftPanel/DiscussionPanelView",["underscore","jquery","Backbone","Displayable","Server","EventBus","TemplateManager","PortfolioActions","AlertActions","DataChest","Modules/Sentiments/Sentiments","Modules/Discussion/Discussion"],function(n,s,e,o,d,a,u,i,r,t,l,c){var m=lcl.makeCustom("DiscussionPanel"),h=16,_=250,p=1e3;return o.extend({_discussion:null,_totalPages:null,_instrumentId:null,_typeId:null,_triggerSource:null,_markupScheme:{watchButton:".js-instrument-tools-watch",watchingButton:".js-instrument-tools-watching",alertButton:".js-instrument-tools-alert-button",portfolioButtonWrapper:".js-instrument-tools-buttons-wrapper",header:".js-discussion-panel-header",headerTitle:".js-discussion-panel-title",discussionContent:".js-discussion-content",socialDiscussion:".js-social-discussion",graphWrapper:".js-discussion-graph-wrapper"},events:{"click .js-discussion-panel-close":"_closePanel","click .js-discussion-panel-link":"_closePanel"},initialize:function(e){o.prototype.initialize.call(this,e),this._discussion=new c("Left Panel"),this._triggerSource="Left Panel"},render:function(e,n){var i=this;return this._totalPages=e.nested.content.vars.lastPage,this._instrumentId=n,u.render({body:e}).then(function(e){var t=e.body;o.prototype.render.call(i,null,t),i._discussion.render(i._dom.discussionContent),i._bindScrollBehaviour(i._dom.socialDiscussion),a.trigger("addToRecentListEv",n,i._dom.header.data("type-id"),i._dom.header.data("name"),i._dom.header.data("symbol"),i._dom.header.data("instrument-type")),i._initializeGraph(),i._initializeSentiments(),i._initInstrumentTools(),s.later(function(){return i._dom.discussionContent.fOne(".js-post-box-content").focus()})}),this.$el},_initInstrumentTools:function(){var t=this;this._dom.watchButton.on("click",function(){i.openPortfolioPopup(t._instrumentId,t._dom.portfolioButtonWrapper,!1,t._triggerSource),t.GTM("DiscussionPanelWatchButton",t._instrumentId)}),this._dom.watchingButton.on("click",function(){i.openPortfolioPopup(t._instrumentId,t._dom.portfolioButtonWrapper,!1,t._triggerSource),t.GTM("DiscussionPanelWatchButton",t._instrumentId)}),this._dom.alertButton.on("click",function(){r.openSinglePairPopup(t._instrumentId,t._triggerSource),t.GTM("DiscussionPanelAddAlert",t._instrumentId)}),i.on("updateInstrumentToolsButtonsEv",function(e){return n.isIn(e,t._instrumentId)&&t._updateWatchingButtons()})},_initializeGraph:function(){this.setupChart(this._dom.graphWrapper,this._dom.graphWrapper.data("json-hash"),this._dom.graphWrapper.data("default-range"),120)},_initializeSentiments:function(){var e=this.$el.f(".js-sentiments-wrapper");e.exists()&&new l(e,this._triggerSource).render(e)},_updateWatchingButtons:function(){var e=i.isPairInPortfolios(this._instrumentId);this._dom.watchButton.tCl("hide",e),this._dom.watchingButton.tCl("hide",!e)},_bindScrollBehaviour:function(e){var i,s,o,t=this,a=_,r=2,l={},c=[];this._totalPages>=r&&e.on("scroll.lazyLoader",n.debounce(function t(){var n=this;i=e[0].scrollHeight;s=e.height();!c[r]&&e.scrollTop()>=a?(c[r]=!0,m("Getting data for ",r),d.Discussion.LoadMoreComments(r,this._discussion.getTypeId(),this._discussion.getPairId()).then(function(e){l[r]=e,o&&t.call(n)})):e.scrollTop()+s>=i-p&&(o=!0,l[r]&&(o=!1,a=i+_,m("Append, ",r),u.render({newComments:l[r]}).then(function(e){var t=e.newComments;return n._discussion.renderCommentsBatch(t)}),++r>this._totalPages&&e.off("scroll.lazyLoader")))}.bind(this),h)),e.on("scroll.stickyHeader",function(){return t._dom.header.tCl("is-sticky",!!e.scrollTop())})},_closePanel:function(){this.trigger("closeDiscussionPanelEv",this._instrumentId)}})}),define("app/modules/LeftPanel/DiscussionPanel",["underscore","jquery","Backbone","Server","./DiscussionPanelView"],function(e,t,n,i,s){return n.EModel.extend({_bubbleEvents:{_view:["closeDiscussionPanelEv"]},initialize:function(e){this._view=new s(e),this.delegateBubbling()},render:function(){},rerender:function(t,e){var n=this;return i.Render.DiscussionPanel(t,e).then(function(e){return n._view.render(e,t)})}})}),define("app/modules/LeftPanel/ListPanelView",["underscore","jquery","Backbone","Toolset","EventBus","TemplateManager","Displayable"],function(s,c,e,t,d,n,o){return o.extend({_listName:null,_$outerPanel:null,_timeElements:null,_itemElementsById:null,_updateTimeIntervalToken:null,_markupScheme:{"?listItems":".js-panel-list-item","?showMoreButton":".js-panel-list-show-more","?signInLinks":".js-signin-link"},events:{"click .js-close-panel":"_closePanel","?click .js-panel-list-show-more":"_showMore","?click .js-notification-item-link":"_closePanel","?click .js-panel-list-item-delete":"_deleteItem"},initialize:function(e,t){this._$outerPanel=t,this._listName=e},render:function(e){var i=this;n.render({body:e}).then(function(e){var t=e.body,n=c(t);i._$outerPanel.html(n),o.prototype.initialize.call(i,n),o.prototype.render.call(i),i._$outerPanel.aCl("open"),i._scanTimeElements(),i._scanItemElements(),i._updateTimeIntervalToken=s.interval(i._updateTimeAgo.bind(i),s.halfAMinute,!0),i._initSignInLinks()})},appendMoreItems:function(e){var i=this;this._dom.showMoreButton.toggleEl(e.nested.inside.vars.showMore),n.render({body:e}).then(function(e){var t=e.body,n=c(t).mF(".js-panel-list-item");i._dom.listItems.last().after(n),i._dom.listItems.addToThis(n),i._dom.showMoreButton.data("last-timestamp",i._dom.listItems.last().mF(".js-panel-list-item-time").data("timestamp")),i._scanTimeElements(),i._scanItemElements(),i._updateTimeAgo()})},_initSignInLinks:function(){this._dom.signInLinks.href(c.getLoginURL())},_deleteItem:function(e){var t=this,n=e.currentTarget,i=c(n).data(),s=i.itemId,o=i.type,a=i.timestamp,r=this._itemElementsById[s],l=r.index();r.detach(),this._dom.listItems.removeFromThis(r),this.popSystemAlert(c("<span>Item removed </span>").append(c("<span>Undo</span>").on("click",function(){r.injectIntoSet(t._dom.listItems,l),t.trigger("addListItemEv",s,o,a)}))),this.trigger("deleteListItemEv",s,o,a),"news"===o&&d.trigger("unsaveArticleEv",s)},_scanItemElements:function(){var a=this;this._itemElementsById={},s.e$(this._dom.listItems,function(e){var t=e.data("item-id"),n=e.f(".js-panel-list-item-share");if(!a._itemElementsById[t]&&n.exists()){var i=n.data("url"),s=e.mF(".js-panel-list-item-title").textT(),o=e.f(".js-panel-list-item-desc").textT();n.on("click",function(){return d.trigger("FireShareEv",i,s,o||" ")})}a._itemElementsById[t]=e})},_scanTimeElements:function(){this._timeElements=s.map(this._dom.listItems,function(e){return c(e).mF(".js-panel-list-item-time")})},_closePanel:function(){clearInterval(this._updateTimeIntervalToken),this.trigger("closePanelEv",this._listName)},_updateTimeAgo:function(){s.e$(this._timeElements,function(e){return e.text(t.Dates.getTimeElapsed(e.data("timestamp")))})},_showMore:function(e){this.trigger("getMoreListItemsEv",c(e.currentTarget).data("last-timestamp"))}})}),define("app/modules/LeftPanel/ListPanel",["underscore","jquery","Backbone","Server","./ListPanelView"],function(e,t,n,i,s){var o={Notifications:{render:i.Render.NotificationsPanel},SavedItems:{render:i.Render.SavedItems,delete:i.SavedItems.Delete,add:i.SavedItems.Add}};return n.EModel.extend({_renderingFunction:null,_bubbleEvents:{_view:"closePanelEv"},initialize:function(e,t){this._view=new s(e,t),this._view.onMultiple({getMoreListItemsEv:this._fetchMoreListItems.bind(this),deleteListItemEv:o[e].delete,addListItemEv:o[e].add}),this._renderingFunction=o[e].render,this.delegateBubbling()},render:function(){var t=this;this._renderingFunction().then(function(e){return t._view.render(e)})},_fetchMoreListItems:function(e){var t=this;this._renderingFunction(e).then(function(e){return t._view.appendMoreItems(e)})}})}),define("app/modules/LeftPanel/LeftPanelView",["underscore","jquery","Backbone","Displayable","DataChest"],function(n,t,e,i,s){var o=".js-left-panel-channel-item",a="shrinked",r=["data-instrument-id","data-instrument-name","data-instrument-type","data-type-id"];return i.extend({_$channelItemClone:null,_panelTimeoutCloseToken:null,_markupScheme:{mainContainer:".js-left-panel-main-container","?searchWrapper":".js-left-panel-search-wrapper","?searchInput":".js-instrument-search-input","?addSymbolButton":".js-left-panel-add-symbol-button",expandButton:".js-left-panel-enlarge-button",notificationsCounter:".js-left-panel-notifications-counter",leftPanelWrapper:".js-left-panel-wrapper",notificationsButton:".js-left-panel-notifications-button",savedItemsButton:".js-left-panel-saved-items-button","?recentList":".js-left-panel-channel-list[data-type='recent']",popularList:".js-left-panel-channel-list[data-type='popular']"},events:{"click .js-left-panel-notifications-button":"_openNotificationsPanel","click .js-left-panel-saved-items-button":"_openSavedItemsPanel","click .js-left-panel-enlarge-button":"_togglePanelExpansion"},initialize:function(e){i.prototype.initialize.call(this,e)},render:function(){return i.prototype.render.call(this),this._bindAddSymbolEvents(),this._$channelItemClone=this._dom.popularList.mF(o).first().clone().rAttr(r),this._bindChannelListItems(this._dom.popularList),this.$el},getPanel:function(){return this._dom.leftPanelWrapper},showPanel:function(){this._dom.leftPanelWrapper.aCl("open")},closePanel:function(e){this._unmarkChannels(),this._dom.leftPanelWrapper.rCl("open"),"Notifications"===e&&this.GTM("leftPanelToggleNotification","Closed")},renderRecentList:function(e){var l=this,c=[];return this._dom.recentList.buildAndPopulate(e,function(e){var t=e.instrumentId,n=e.typeId,i=e.name,s=(e.symbol,e.icon),o=e.firstLetter,a=e.instrumentType,r=l._$channelItemClone.clone();return r.data("instrument-id",t).data("type-id",n).data("instrument-type",a),r.mF('[data-element="label"]').textT(i),r.mF('[data-element="icon"]').rCl("color-1 color-2 color-3 color-4 color-5 color-6 color-7 color-8 color-9").aCl("color-".concat(s)),r.mF('[data-element="letter"]').textT(o),r.getButton().title(i),c.push({pId:t,name:i,type:a}),r}),this._bindChannelListItems(this._dom.recentList),c},_bindChannelListItems:function(e){var t=this;n.e$(e.f(o),function(e){s.loadInstrumentData({name:e.f(".text").textT(),type:e.data("instrument-type"),pId:e.data("instrument-id")}),e.getButton().on("click",t._openDiscussionPanel.bind(t,e.data("instrument-id"),e.data("type-id"),e.getButton()))})},_bindAddSymbolEvents:function(){var t=this;this.setupInstrumentSearch(this._dom.searchWrapper,function(e){t._openDiscussionPanel(e),t._toggleEditMode(!1)}),this._dom.addSymbolButton.on("click",function(){t._toggleEditMode(!0),t._dom.searchInput.focus()}),this._dom.searchInput.onTimeoutBlur(this._toggleEditMode.bind(this,!1),256),this._dom.searchInput.onEsc(this._toggleEditMode.bind(this,!1))},_markChannelAsSelected:function(e){this._unmarkChannels(),e.setSelected()},_unmarkChannels:function(){this._dom.mainContainer.f(o).getButton().unselect(),this._dom.notificationsButton.unselect(),this._dom.savedItemsButton.unselect()},_openDiscussionPanel:function(e,t,n){this._unmarkChannels(),n&&this._markChannelAsSelected(n),this.GTM("InstrumentClickedFromLeftPanel",e),this.trigger("openDiscussionPanelEv",e,t)},_openNotificationsPanel:function(e){this._dom.notificationsCounter.textT("0").hideEl(),this._markChannelAsSelected(t(e.currentTarget)),this.trigger("openNotificationsPanelEv"),this.GTM("leftPanelToggleNotification","Opened")},_openSavedItemsPanel:function(e){this._markChannelAsSelected(t(e.currentTarget)),this.trigger("openSavedItemsPanelEv")},_togglePanelExpansion:function(){this.GTM("leftPanelTogglePanel",this._dom.mainContainer.hCl(a)?"Expand":"Minimize"),this._dom.expandButton.togglePress(),this._dom.mainContainer.tCl(a)},_toggleEditMode:function(e){e&&this._dom.mainContainer.hCl(a)&&this._togglePanelExpansion(),this._dom.searchWrapper.toggleEl(e),this._dom.addSymbolButton.toggleEl(!e)}})}),define("app/modules/LeftPanel/LeftPanel",["underscore","jquery","Backbone","Server","EventBus","Toolset","DataChest","./DiscussionPanel","./ListPanel","./LeftPanelView"],function(r,e,t,n,a,l,i,s,o,c){var d="Left Panel";return t.EModel.extend({_recentList:null,initialize:function(e){this._view=new c(e),this._recentList=l.UserStorage.getObj("_rec_")||[]},render:function(e){var t=this;this._view.render(),this._view.onMultiple({openDiscussionPanelEv:this._rerenderDiscussionPanel.bind(this),openSavedItemsPanelEv:function(){return t._savedItemsPanel.render()},openNotificationsPanelEv:function(){return t._notificationsPanel.render()}}),this._initDiscussionPanel(),this._initSavedItemsPanel(),this._initNotificationsPanel(),a.onMultiple({openDiscussionEv:this._rerenderDiscussionPanel.bind(this),addToRecentListEv:this._addToRecent.bind(this)}),e?this._addToRecent.apply(this,_toConsumableArray(e).concat([!0])):this._renderRecentAndLoad()},_renderRecentAndLoad:function(){var e=this._view.renderRecentList(this._recentList);i.loadInstrumentData(e)},_addToRecent:function(t,e,n,i,s,o){if(r.isE(this._recentList)||r.first(this._recentList).instrumentId!==t){var a=r.findIndex(this._recentList,function(e){return e.instrumentId===t});~a?r.relocate(this._recentList,a,0):this._recentList.unshift(this._makeRecentItemData(t,e,n,i,s)),r.removeBeyondIndex(this._recentList,5),o||this._renderRecentAndLoad(),l.UserStorage.setObj("_rec_",this._recentList)}o&&this._renderRecentAndLoad()},_initDiscussionPanel:function(){var t=this;this._discussionPanel=new s(this._view.getPanel()),this._discussionPanel.on("closeDiscussionPanelEv",function(e){t._view.closePanel(),t.GTM("DiscussionPanelOpened","Close",d,e)})},_initNotificationsPanel:function(){var t=this;this._notificationsPanel=new o("Notifications",this._view.getPanel()),this._notificationsPanel.on("closePanelEv",function(e){return t._view.closePanel(e)})},_initSavedItemsPanel:function(){var t=this;this._savedItemsPanel=new o("SavedItems",this._view.getPanel()),this._savedItemsPanel.on("closePanelEv",function(e){return t._view.closePanel(e)})},_rerenderDiscussionPanel:function(e,t,n){var i=this,s=1<arguments.length&&void 0!==t?t:5,o=2<arguments.length&&void 0!==n?n:d;a.trigger("indicateLoadingEv"),this._discussionPanel.rerender(e,s).then(function(){a.trigger("indicateLoadingOffEv"),i._view.showPanel(),i.GTM("DiscussionPanelOpened","Open",o,e)})},_makeRecentItemData:function(e,t,n,i,s){return{name:n,instrumentId:e,symbol:i,instrumentType:s,typeId:t||5,firstLetter:r.toUpperCase(n?n[0]:i[0]),icon:e%9+1}}})});