"use strict";function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(t,e){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)){var i=[],r=!0,o=!1,n=void 0;try{for(var s,a=t[Symbol.iterator]();!(r=(s=a.next()).done)&&(i.push(s.value),!e||i.length!==e);r=!0);}catch(t){o=!0,n=t}finally{try{r||null==a.return||a.return()}finally{if(o)throw n}}return i}}function _arrayWithHoles(t){if(Array.isArray(t))return t}define("app/modules/RightsidePanel/MarketPanelView",["underscore","jquery","Backbone","Displayable","PortfolioActions","TemplateManager","InstrumentChart","Modules/SortableList/SortableList"],function(d,l,t,e,i,o,r,n){var s=l(document);return e.extend({_markupScheme:{mainTabsWrapper:".js-rightside-market-main-tabs",subTabsWrapper:".js-rightside-market-sub-tabs","?subTabs":".js-rightside-market-sub-tab",mainTabsArrowLeft:'[data-market-main-tab-arrow="left"]',mainTabsArrowRight:'[data-market-main-tab-arrow="right"]',addInstrument:".js-rightside-market-search-instrument",addInstrumentWrapper:".js-rightside-market-add-instrument",addInstrumentInput:".js-instrument-search-input",showAddInstrumentButton:".js-rightside-market-show-search-instrument",categoryList:".js-rightside-market-categories-list",categoryListScroller:".js-rightside-market-categories-scroller",categoryListItemClone:".js-rightside-market-categories-item[clone]",mainSettings:".js-rightside-market-settings-main",mainSettingsEdit:".js-rightside-market-settings-edit",createNewPortfolioWrapper:".js-rightside-market-new-portfolio",settingsRange:".js-rightside-market-settings-range",settingsSize:".js-rightside-market-settings-size",categoryWrapper:".js-market-category-content",categoryButtons:".js-rightside-market-category",settingsEditTitle:".js-rsms-title",settingsEditDataType:"[name=js-rmse-data-type]",settingsEditTitleType:"[name=js-rmse-title-type]"},events:{"input .js-rightside-market-settings-range":"_updateSettingsAndRange","input .js-rightside-market-settings-size":"_updateSettingsAndRerender","input [name=js-rmse-data-type],[name=js-rmse-title-type]":"_updateListItem","@click .js-rmse-back":"_exitEditMode"},_currentTabId:null,_$subTabClone:null,_tabsWidthSum:null,_settingsPopup:null,_$periodButtons:null,_lastChartOptions:null,_categoryIdToTabLI:null,_mainTabsController:null,_changedRangeSetting:null,_currentlyEditingItem:null,_categoryIdToSettingsLI:null,_deleteInstrumentButtons:null,_currentlyEditingPortfolio:null,_categoryIdToFirstSubTabId:null,initialize:function(t){e.prototype.initialize.call(this,t)},render:function(){return e.prototype.render.call(this),this.setToObjects("_categoryIdToSettingsLI","_lastChartOptions"),this._bindRowsChartRendering(),this._initReorderability(),this._initMainTabsScrollability(),this._soakCategoriesData(),this._calculateCurrents(),this._initializeComponents(),this._updateTabsRightArrow(),this.$el},rerenderCategoryInView:function(t,i){var r=this;o.render({category:t}).then(function(t){var e=t.category;r._dom.categoryWrapper.html(e),r._toggleAddInstrument(),r._subscribeTableToSocket(),r._currentlyEditingPortfolio&&r._togglePortfolioEditMode(!0),r._bindRowsChartRendering(i)})},getCurrentTab:function(){return this._currentTabId},updateMainTabs:function(t){var e,i=this,r=t.settings,o=r.order,n=r.display,s=l();d.e(o,function(t){return i._categoryIdToTabLI[t]&&s.addToThis(i._categoryIdToTabLI[t].toggleEl(d.isIn(n,t)))}),this._dom.mainTabsWrapper.html(s.detach()),e=this._categoryIdToTabLI[this._currentTabId].getButton(),this._mainTabsController.switchToTabSilent(this._dom.categoryButtons.index(e),e),this._updateTabsRightArrow()},addNewPortfolio:function(t,e,i){this._idToCategoryName[t]=e,this._dom.categoryList.prepend(this._buildSettingsListItem({id:t,isSelected:!i})),this._dom.mainTabsWrapper.prepend(this._buildNewMainTab(t,e,i)).scrollLeft(0),i||(this._dom.mainTabsArrowLeft.hideEl(),this._currentTabId=t,this._currentParentTabId=t,this._currentlyEditingPortfolio=!0,this._saveMarketSettings(),this._settingsPopup.close())},indicatePortfolioModification:function(t){var e=this;d.e(t,function(t){return e._categoryIdToTabLI[t]&&e._categoryIdToTabLI[t].highlight()})},_renderChart:function(t){var e,i,r=this._$periodButtons.getSelected().data("period"),o=this._dom.categoryWrapper.mF(".js-market-graph-wrapper-link"),n=o.mF(".js-market-graph-wrapper"),s=this._getInstrumentsTable();if(s.exists()&&s.mF("tr").unmark(),t){var a=t.f(".js-instrument-page-link");i=a.exists()?a.href():"",e=t.data("json-hash"),i?o.href(i):o.rAttr("href"),this._lastChartOptions={jsonHash:e,link:i,period:r},t.mark()}else e=this._lastChartOptions.jsonHash,this._lastChartOptions.period=r;this.setupChart(n,e,r)},_bindRowsChartRendering:function(t){var i=this,e=this._getInstrumentsTable();if(e.exists()){this._$periodButtons=this._dom.categoryWrapper.mF(".js-market-graph-period");var r=e.mF("tr"),o=this.setupTabs(this._$periodButtons,null,{customHandler:function(){return i._renderChart()}}),n=this._lastChartOptions.period,s=d.isSizeOne(t);n&&!this._changedRangeSetting&&o.switchToTabSilent(this._$periodButtons.indexOf(function(t){return t.data("period")===n})),this._changedRangeSetting=null,this._renderChart(r.first()),r.on("click",function(t){var e=t.currentTarget;i._renderChart(l(e),!0),i.GTM("InstrumentClickedFromRightside","Markets",l(e).data("s"))}),d.e$(r,function(t){var e;t.hover(function(){return e=setTimeout(function(){return i._renderChart(t,!0)},500)},function(){return clearTimeout(e)})}),s&&r.filter('[data-s="'.concat(t[0],'"]')).highlight()}},_soakCategoriesData:function(){var n=this;this._idToCategoryName={},this._categoryIdToTabLI={},this._categoryIdToFirstSubTabId={},d.e$(this._dom.mainTabsWrapper.mF("li"),function(e){var t=e.getButton(),i=t.data("category-id"),r=t.attr("data-subcategories-id");if(n._idToCategoryName[i]=t.textT(),n._categoryIdToTabLI[i]=e,r){var o=r.split(",");n._categoryIdToFirstSubTabId[i]=o[0],d.e(o,function(t){return n._categoryIdToTabLI[t]=e})}})},_navigateToCategory:function(t){var e=t.currentTarget,i=l(e),r=i.data("category-id"),o=i.attr("data-subcategories-id"),n=i.data("subcategories-name"),s=i.hasAttr("data-sub-tab");s||(this._rebuildSubcategories(o,n),this._currentParentTabId=r,n&&(r=this._categoryIdToFirstSubTabId[r])),this.GTM("RightsideMarketsSubTab",i.textT(),s),this._currentTabId=r,this.trigger("marketCategoryNavEv",r)},_rebuildSubcategories:function(t,e,i){var r=this,o=0<arguments.length&&void 0!==t?t:"",n=1<arguments.length&&void 0!==e?e:"";if(!(2<arguments.length&&void 0!==i&&i)){var s=l(),a=n.split(",");d.e(d.clean(o.split(",")),function(t,e){var i=r._$subTabClone.clone();i.mF("button").textT(a[e]).data("category-id",t).toggleSelected(!e),s.addToThis(i)}),this._dom.subTabsWrapper.html(s),this._dom.subTabs=s}this.setupTabs(this._dom.subTabs.f("button"),null,{customHandlerE:this._navigateToCategory.bind(this)})},_updateSettingsAndRange:function(){var t=this;this._changedRangeSetting=this._dom.settingsRange.val(),this.loginOrImmediate(function(){return t._saveMarketSettings(!0)})},_updateSettingsAndRerender:function(){var t=this;this.loginOrImmediate(function(){return t._saveMarketSettings(!0)})},_saveMarketSettings:function(t){var e,i=[],r=[];if(this.abortCall("Settings","Render"),d.mapObject(this._categoryIdToSettingsLI,function(t,e){i[t.index()]=e,t.mF(".js-rmci-checkbox").enable().isChecked()&&(r[t.index()]=+e)}),e=d.clean(r),d.isSizeOne(e)&&this._applyCheckboxDisability(e[0]),d.isntIn(e,this._currentParentTabId)){this._currentTabId=this._categoryIdToFirstSubTabId[e[0]]||e[0],this._currentParentTabId=e[0];var o=this._categoryIdToTabLI[this._currentParentTabId].getButton().data(),n=o.subcategoriesId,s=o.subcategoriesName;this._rebuildSubcategories(n,s)}this.trigger("updateMarketSettingsEv",this._currentTabId,i,e,this._dom.settingsRange.val(),this._dom.settingsSize.val(),t)},_initializeComponents:function(){var e=this;this._dom.categoryListItemClone.remove().rCl("js-rightside-market-categories-item").rAttr("clone"),this._dom.showAddInstrumentButton.on("click",function(){return e._togglePortfolioEditMode(!0)}),this._dom.addInstrumentInput.onEsc(function(){return e._togglePortfolioEditMode(!1)}),this.setupInstrumentSearch(this._dom.addInstrument,function(t){return e.trigger("addInstrumentToMarketEv",e._currentParentTabId,t)}),this._mainTabsController=this.setupTabs(this._dom.categoryButtons,null,{customHandlerE:this._navigateToCategory.bind(this)}),this._$subTabClone=this._dom.subTabs.first().clone(),this._$subTabClone.getButton().hasAttr("data-category-id")||this._dom.subTabs.remove(),this._rebuildSubcategories(null,null,!0),this._settingsPopup=this.setupPopup(this.$el,".js-rightside-market-settings",".js-rightside-market-settings-popup",{beforeOpen:this._populateMarketSettings.bind(this),afterOpen:function(){return e._dom.categoryListScroller.scrollToTop()},onClose:this._exitEditMode.bind(this),skipCloseBind:!0,openLeftwards:!0}),i.bindCreatePortfolio(this._dom.createNewPortfolioWrapper,this.addNewPortfolio.bind(this),null,"Right Panel"),this._dom.createNewPortfolioWrapper.mF(".js-show-create-portfolio").on("click",function(){return e.GTM("NewPortfolioButtonClicked",{triggerSource:"Right Panel"})}),this._subscribeTableToSocket()},_toggleAddInstrument:function(){var t=this.ask("RightsideMarketSettingsSizeQ"),e=this._getInstrumentsTable(),i=!1;this._currentTabId===this._currentParentTabId&&(i=!e.exists()||e.mF("tr").length<t);this._dom.addInstrumentWrapper.toggleEl(i)},_calculateCurrents:function(){this._currentTabId=this._dom.mainTabsWrapper.mF(".js-rightside-market-category.selected").data("category-id"),this._categoryIdToFirstSubTabId[this._currentTabId]?(this._currentParentTabId=this._currentTabId,this._currentTabId=this._categoryIdToFirstSubTabId[this._currentTabId]):this._currentParentTabId=this._currentTabId},_applyCheckboxDisability:function(t){this._categoryIdToSettingsLI[t].mF(".js-rmci-checkbox").disable()},_populateMarketSettings:function(){var e=this,t=this.ask("RightsideMarketSettingsQ"),i=t.list,r=t.range,o=t.size,n=d.filter(i,function(t){return t.isSelected}),s=d.filter(i,function(t){return e._categoryIdToTabLI[t.id]});this._dom.categoryList.buildAndPopulate(s,this._buildSettingsListItem.bind(this)),this._dom.settingsRange.val(r),this._dom.settingsSize.val(o),d.isSizeOne(n)&&this._applyCheckboxDisability(n[0].id)},_buildNewMainTab:function(t,e,i){var r=this._dom.mainTabsWrapper.mF("li").first().clone().toggleEl(!i);return this._mainTabsController.addTab(r.getButton().toggleSelected(!i).rAttr("data-subcategories-name").rAttr("data-subcategories-id").data("category-id",t).textT(e)),this._categoryIdToTabLI[t]=r},_buildSettingsListItem:function(t){var e=this,i=t.id,r=t.isSelected,o=this._dom.categoryListItemClone.clone(),n=o.mF(".js-rmci-edit"),s=o.mF(".js-rmci-checkbox");return o.data("id",i).mF(".js-rmci-label").textT(this._idToCategoryName[i]),s.on("input",this.loginOr(function(){return e._saveMarketSettings(),n.toggleEl(s.isChecked())})).check(!!r),n.on("click",function(){return e._editListItem(i,e._idToCategoryName[i])}).toggleEl(!!r),this._categoryIdToSettingsLI[i]=o},_updateListItem:function(){var t=this,e=_slicedToArray(this._currentlyEditingItem,2),i=e[0],r=e[1];this.loginOrImmediate(function(){return t.trigger("updateMarketSettingEv",t._currentTabId,i,r,t._dom.settingsEditTitleType.getChecked().val(),t._dom.settingsEditDataType.getChecked().val(),t._currentParentTabId===+i)})},_deleteInstrumentFromPortfolio:function(t){this.trigger("removeInstrumentFromMarketEv",this._currentParentTabId,t)},_editListItem:function(t,e){var i=this.ask("RightsideMarketItemQ",t),r=i.type,o=i.dataType,n=i.titleType;this._dom.settingsEditTitleType.filter("[value=".concat(n,"]")).check(),this._dom.settingsEditDataType.filter("[value=".concat(o,"]")).check(),this._currentlyEditingItem=[t,r],this._dom.settingsEditTitle.textT(this._dom.settingsEditTitle.data("raw").replace("%%category%%",e)),this._toggleEditMode(!0)},_togglePortfolioEditMode:function(t){var o=this,e=this._getInstrumentsTable();e.exists()&&(t&&e.mF("tr").length<this.ask("RightsideMarketSettingsSizeQ")?(this._deleteInstrumentButtons=l(),d.e$(e.mF("tr"),function(t){var e=t.data("s"),i=t.mF("td:last"),r=l('<button class="icon-button" aria-label="delete item"><span class="icon-delete" aria-hidden="true"></span></button>');i.f(">").hideEl(),i.append(r.on("click",function(){return o._deleteInstrumentFromPortfolio(e)})),o._deleteInstrumentButtons.addToThis(r)}),s.on("click.marketPanelEditMode",this._togglePortfolioEditMode.bind(this,!1)),s.onEsc(this._togglePortfolioEditMode.bind(this,!1),!1,"marketPanelEditMode"),this._dom.categoryWrapper.add(this._dom.addInstrumentWrapper).on("click.marketPanelEditMode",d.sP)):(this._deleteInstrumentButtons.remove(),d.e$(e.f("tr"),function(t){return t.mF("td:last>").showEl()}),this._dom.categoryWrapper.add(this._dom.addInstrumentWrapper).off("click.marketPanelEditMode"),s.off("click.marketPanelEditMode").off("keydown.marketPanelEditMode"))),this._dom.showAddInstrumentButton.toggleEl(!t),this._dom.addInstrument.toggleEl(t),t&&this._dom.addInstrumentInput.focus(),t||this._dom.addInstrumentInput.val(""),this._currentlyEditingPortfolio=t},_exitEditMode:function(){this._toggleEditMode(!1)},_toggleEditMode:function(t){this._dom.mainSettings.toggleEl(!t),this._dom.mainSettingsEdit.toggleEl(t)},_getInstrumentsTable:function(){return this._dom.categoryWrapper.f(".js-streamable-table")},_updateTabsRightArrow:function(){var t=this._dom.mainTabsWrapper.mF("li:not(.hide)").widthSum(),e=t>this._dom.mainTabsWrapper.width();this._dom.mainTabsArrowRight.toggleEl(e),this._tabsWidthSum=t,e||this._toggleTabsLeftArrow(!1)},_subscribeTableToSocket:function(){this.subscribeTableToSocket(this._getInstrumentsTable())},_toggleTabsLeftArrow:function(t){this._dom.mainTabsArrowLeft.toggleEl(t)},_initMainTabsScrollability:function(){var t=this;this._dom.mainTabsArrowLeft.on("click",function(){return t._scrollMainTabs(!1)}),this._dom.mainTabsArrowRight.on("click",function(){return t._scrollMainTabs(!0)})},_scrollMainTabs:function(t){var e=this;t&&this._toggleTabsLeftArrow(!0);var i=this._dom.mainTabsWrapper.scrollLeft()+200*(+t||-1);this._dom.mainTabsWrapper.animate({scrollLeft:i},80,function(){e._dom.mainTabsArrowRight.toggleEl(!t||i===e._dom.mainTabsWrapper.scrollLeft()&&i!==e._tabsWidthSum-e._dom.mainTabsWrapper.outerWidth())}),this._dom.mainTabsArrowLeft.toggleVis(0<i),this._dom.mainTabsArrowRight.toggleEl(!t||1)},_initReorderability:function(){var t=this;new n(this.$el.mF(".js-rightside-market-categories-list"),{handle:"li",onEndHandler:this.loginOr(function(){return t._saveMarketSettings()})})}})}),define("app/modules/RightsidePanel/MarketPanel",["underscore","jquery","Backbone","Toolset","EventBus","Server","DataChest","./MarketPanelView"],function(s,t,e,i,o,a,r,n){return e.EModel.extend({_settingsFromServer:null,initialize:function(t){this._view=new n(t),this._settingsFromServer=r.get("marketData")},render:function(){var r=this;this._view.onMultiple({marketCategoryNavEv:this.rerenderCategory.bind(this),updateMarketSettingEv:this._updateMarketSetting.bind(this),updateMarketSettingsEv:this._updateMarketSettings.bind(this),addInstrumentToMarketEv:this._addInstrumentToMarket.bind(this),removeInstrumentFromMarketEv:this._removeInstrumentFromMarket.bind(this)}).answerMultiple({RightsideMarketItemQ:this._getListItem.bind(this),RightsideMarketSettingsQ:this._getMarketList.bind(this),RightsideMarketSettingsSizeQ:this._getMarketListSize.bind(this)}),this._view.render(),this._currentTabId=this._view.getCurrentTab(),o.on("portfolioModifiedEv",function(t,e){function i(){return!s.isSizeOne(e)&&r._view.indicatePortfolioModification([t])}+t===r._currentTabId?r.rerenderCategory(t,e).then(i):i()}),o.on("portfolioCreatedEv",function(t,e){r._settingsFromServer.settings.order.push(t),r._view.addNewPortfolio(t,e,!0)})},rerenderCategory:function(t,e){var i=this,r=this._settingsFromServer.data[t];return this._currentTabId=+t,a.Render.RightsideMarket(t,r&&r.type.is("portfolio")).then(function(t){return i._view.rerenderCategoryInView(t,e)})},rerenderOnPortfoliosUpdate:function(t,e){function i(){return!n&&r._view.indicatePortfolioModification(t)}var r=this,o=s.isIn(t,""+this._currentTabId),n=s.isSizeOne(e);o?this.rerenderCategory(s.isSizeOne(t)?t[0]:this._currentTabId,e).then(i):i()},_updateMarketSetting:function(t,e,i,r,o,n){a.MarketPanel.SaveSetting(e,i,r,o).then(this._makeRerenderAndUpdate(t,n))},_updateMarketSettings:function(t,e,i,r,o,n){a.MarketPanel.SaveSettings(e,i,r,o).then(this._makeRerenderAndUpdate(t,n))},_addInstrumentToMarket:function(e,t){var i=this;a.Portfolio.AddPair(e,t).then(function(t){i.rerenderCategory(e),t&&i.GTM("InstrumentAddedToPortfolio",{triggerSource:"Right Panel",eventValue:1,instrumentType:"NA",instrumentName:"NA"})})},_removeInstrumentFromMarket:function(t,e){var i=this;a.Portfolio.RemovePair(t,e).then(function(){return i.rerenderCategory(t)})},_makeRerenderAndUpdate:function(i,r){var o=this;return function(t){var e=t.data;o._settingsFromServer=e,o._currentTabId===i&&!r||o.rerenderCategory(i),o._currentTabId=i,o._view.updateMainTabs(e)}},_getMarketListSize:function(){return this._settingsFromServer.settings.maxInstruments},_getMarketList:function(){var e=this,i={range:this._settingsFromServer.settings.chartRange,size:this._settingsFromServer.settings.maxInstruments,list:[]};return s.e(this._settingsFromServer.settings.order,function(t){return i.list.push({id:t,isSelected:s.isIn(e._settingsFromServer.settings.display,t)})}),i},_getListItem:function(t){return this._settingsFromServer.data[t]}})}),define("app/modules/RightsidePanel/PortfolioPanelView",["underscore","jquery","Backbone","Displayable","DataChest","TemplateManager","PortfolioActions","Modules/SortableList/SortableList","Modules/ControlPanel/FunctionalElementView"],function(d,l,t,e,r,i,o,n,u){return e.extend({_settingsPopup:null,_lastOpenStates:null,_scrollDownOnEnd:null,_editedPortfolioId:null,_portfolioIdToWrapper:null,_debouncedSaveSettings:null,_portfolioIdToSettingsCheckbox:null,_portfolioIdsToSettingsElements:null,_markupScheme:{settingsPortfoliosList:".js-rsps-portfolios",portfolioClone:".js-rsps-portfolio-clone",addNewPortfolio:".js-rsps-portfolio-add-new"},initialize:function(t){e.prototype.initialize.call(this,t),this._debouncedSaveSettings=d.debounce(this._saveSettings.bind(this),400)},render:function(){return e.prototype.render.call(this),this.initPortfolioWrappersInView(),this._initComponents(),this.$el},initPortfolioWrappersInView:function(){var i=this;return this._portfolioIdToWrapper={},d.e$(this.$el.f(".js-rightside-portfolio"),this._initializePortfolio.bind(this)),this.$el.f("tr").on("click",function(t){var e=t.currentTarget;return i.GTM("InstrumentClickedFromRightside","Portfolios",l(e).data("s"))}),this},rerenderPortfolioInView:function(n,t,s){var a=this;i.render({renderedCont:t}).then(function(t){var e=t.renderedCont,i=l(e),r=a._portfolioIdToWrapper[n],o=r.mF(".js-accordion").is(".open");i.mF(".js-accordion").tCl("open",o),r.replaceWith(i),a._initializePortfolio(i),i.f(".js-table-scroller").scrollToTop(),d.isSizeOne(s)&&o&&i.f('[data-s="'.concat(s[0],'"]')).exists()?i.mF('[data-s="'.concat(s[0],'"]')).highlight():i.mF(".js-accordion").highlight()})},indicatePortfolioModification:function(t){var e=this;t&&d.e(t,function(t){return e._portfolioIdToWrapper[t]&&e._portfolioIdToWrapper[t].mF(".js-accordion").highlight()})},populateSettings:function(){var r=this,o=l(),t=this.ask("portfoliosListQ"),e=t.order,n=t.portfolios;this._portfolioIdsToSettingsElements=l(),this._portfolioIdToSettingsCheckbox={};var i=d.sameSize(e,n)?e:d.array(e,d.keys(d.omit(n,e)));d.e(i,function(t){var e=n[t],i=r._dom.portfolioClone.clone().data("id",+t);e?(i.mF(".js-rsps-portfolio-label").textT(e.name),r._portfolioIdToSettingsCheckbox[t]=i.mF(".js-rsps-portfolio-checkbox").check(e.display).on("input",function(){return r._debouncedSaveSettings(null,!0)}),r._portfolioIdsToSettingsElements.addToThis(i),o.addToThis(i)):announceWarn("Portfolio Panel Order contains non-existent portfolio. Id:",t)}),d.isSizeOne(d.filter(n,function(t){return t.display}))&&this._applyCheckboxDisability(d.findKey(n,function(t){return t.display})),this._dom.settingsPortfoliosList.html(o)},isPortfolioVisible:function(t){return!!this._portfolioIdToWrapper[t]},getVisiblePortfolios:function(){return d.keys(this._portfolioIdToWrapper)},_initComponents:function(){var e=this;this._settingsPopup=this.setupPopup(this.$el,".js-rightside-portfolio-settings-opener",".js-rightside-portfolio-settings-popup",{beforeOpen:this.populateSettings.bind(this),skipCloseBind:!0,openLeftwards:!0}),this._dom.portfolioClone.remove().rCl("js-rsps-portfolio-clone"),this.$el.f(".js-rightside-portfolios-create-new").on("click",this.loginOr(function(){return 1})),o.bindCreatePortfolio(this._dom.addNewPortfolio,function(t){return e._debouncedSaveSettings(t)},null,"Right Panel"),this._dom.addNewPortfolio.mF(".js-show-create-portfolio").on("click",function(){return e.GTM("NewPortfolioButtonClicked",{triggerSource:"Right Panel"})}),new n(this._dom.settingsPortfoliosList,{handle:"li",onEndHandler:function(){return e._debouncedSaveSettings(null,!0)}})},_saveSettings:function(t,e){var r=[],o=[];this.abortCall("Settings","Render"),d.e$(this._portfolioIdsToSettingsElements,function(t){var e=t.data("id"),i=t.mF(".js-rsps-portfolio-checkbox").enable().isChecked();r[t.index()]=e,o[t.index()]=i&&e}),o=d.clean(o),d.isSizeOne(o)&&this._applyCheckboxDisability(o[0]),t&&(r.unshift(t),o.unshift(t)),this._updateOpenStates(),e||this._closeSettings(),this.trigger("savePortfolioSettingsEv",{order:r,display:o},e)},_applyCheckboxDisability:function(t){this._portfolioIdToSettingsCheckbox[t].disable()},_updateOpenStates:function(){var i={};d.e$(this._portfolioIdToWrapper,function(t,e){i[e]=t.mF(".js-accordion").is(".open")}),r.setClientData("lastRSPortfolioOpenStates",i)},_closeSettings:function(){this._settingsPopup.close()},_initializePortfolio:function(t){function e(){return n.showEl(),a.focus()}function i(){return n.hideEl()}var r=this,o=t.data("portfolio-id"),n=t.f(".js-portfolio-instrument-search"),s=t.f(".js-portfolio-full-portfolio-button"),a=n.f(".js-instrument-search-input"),d=t.f(".js-rightside-portfolio-resizer");this._portfolioIdToWrapper[o]=t,n.exists()&&(this.setupInstrumentSearch(n,function(t){r._editedPortfolioId=o,r.trigger("addInstrumentToPortfolioEv",o,t)}),t.f(".js-show-instrument-search").on("click",function(){e(),r.GTM("PortfolioAddSymbolClicked")}),a.on("blur",function(){return setTimeout(i,156)}).onEsc(i),this._editedPortfolioId===o&&(this._editedPortfolioId=null,e())),s.on("click",function(){return r.navigate(s.data("link"))}),d.exists()&&new u({lsKey:"rightsidePortfolio".concat(o),$element:t.mF(".js-table-scroller"),resize:{$resizeBar:d,boundaries:{height:function(t){return 95<t&&t<631}}}}),this.setupAccordion(t.mF(".js-accordion"),function(){return r._updateOpenStates()})}})}),define("app/modules/RightsidePanel/PortfolioPanel",["underscore","jquery","Backbone","Server","EventBus","Toolset","./PortfolioPanelView"],function(n,t,e,s,r,o,i){return e.EModel.extend({_rerenderBound:null,initialize:function(t){var o=this;this._view=new i(t),this._view.answer("portfoliosListQ",this._getPortfoliosList.bind(this)),this._rerenderBound=this.rerenderPortfolio.bind(this),r.onMultiple({portfolioModifiedEv:this._rerenderBound,portfolioCreatedEv:function(t){var e=o._getPortfoliosList(),i=e.portfolios,r=e.order;i[t].display=!0,r.unshift(+t),o._savePortfolioSettings({order:r,display:n.getNumericKeys(n.filterObject(i,function(t){return t.display}))})}})},render:function(t){this._view.render(t),this._view.onMultiple({addInstrumentToPortfolioEv:this._addInstrumentToPortfolio.bind(this),savePortfolioSettingsEv:this._savePortfolioSettings.bind(this)})},destroy:function(){return r.off("portfolioModifiedEv",this._rerenderBound),this},initPortfolioWrappers:function(t){this._view.initPortfolioWrappersInView().indicatePortfolioModification(t)},numberOfVisiblePortfoliosChanged:function(t){return n.size(n.intersection(this._view.getVisiblePortfolios(),t))},rerenderPortfolio:function(e,i,r){var o=this;this._view.isPortfolioVisible(e)&&s.Render.Portfolio(e).then(function(t){return o._view.rerenderPortfolioInView(e,t,i,r)})},_savePortfolioSettings:function(t){var e=this,i=t.order,r=t.display;s.Portfolio.RightsideSettings(i,r).then(function(){return e._updateP2P(i,r)}).then(function(){return e.trigger("rerenderPortfoliosEv",!1)})},_addInstrumentToPortfolio:function(t,e){var i=this;s.Portfolio.AddPair(t,e).then(function(t){t&&i.GTM("InstrumentAddedToPortfolio",{triggerSource:"Right Panel",eventValue:1,pairIds:[e]})})},_getPortfoliosList:function(){return o.ClientStorage.P2P()},_updateP2P:function(t,i){var e=this._getPortfoliosList();e.order=t,n.e(e.portfolios,function(t,e){t.display=n.isIn(i,+e)}),o.ClientStorage.P2P(e),r.trigger("P2PChangedEv",e)}})}),define("app/modules/RightsidePanel/RightsidePanelView",["underscore","jquery","Backbone","Displayable","DataChest","EventBus","TemplateManager"],function(r,o,t,e,n,i,s){return e.extend({_markupScheme:{innerWrapper:".js-rightside-panel-inner-wrapper",tabButtons:".js-rightside-tab-button",marketWrapper:".js-rightside-market-wrapper",portfoliosWrapper:".js-rightside-portfolios-wrapper",accordionButton:".js-rightside-accordion-button",componentsWrapper:".js-right-side-components-wrapper"},events:{"click .js-rightside-accordion-button":"_togglePanelAccordion"},initialize:function(t){e.prototype.initialize.call(this,t)},render:function(){return e.prototype.render.call(this),i.trigger("subscribeForPartialRenderEv","right_side",this._dom.componentsWrapper,".js-right-side-components-wrapper"),this.setupTabs(this._dom.tabButtons,null,{customHandler:this._switchToRightsideTabMain.bind(this)}),this.$el},rerenderPortfolios:function(t){var r=this;return s.render({renderedCont:t}).then(function(t){var e=t.renderedCont,i=o(e).toggleEl(!0);r._applyOpenCloseStates(i),r._dom.portfoliosWrapper.mF(".js-rightside-portfolios-content").replaceWith(i)})},getMarketWrapper:function(){return this._dom.marketWrapper},getPortfolioWrapper:function(){return this._dom.portfoliosWrapper},_togglePanelAccordion:function(){this.$el.toggleIsOpen()},_switchToRightsideTabMain:function(t){this._dom.marketWrapper.toggleEl(!t),this._dom.portfoliosWrapper.toggleEl(t),this.GTM("RightsideMainTab",t?"Portfolio":"Markets"),i.trigger("refreshDFPsInContainerEv",this._dom.innerWrapper,!0)},_applyOpenCloseStates:function(t){var i=n.getClientData("lastRSPortfolioOpenStates")||{};r.e$(t.f(".js-rightside-portfolio"),function(t){var e=t.data("portfolio-id");t.mF(".js-accordion").tCl("open",r.valueOr(i[e],!0))})}})}),define("app/modules/RightsidePanel/RightsidePanel",["underscore","jquery","Backbone","EventBus","Server","./MarketPanel","./PortfolioPanel","./RightsidePanelView"],function(t,e,i,r,o,n,s,a){return i.EModel.extend({initialize:function(t){this._view=new a(t)},render:function(){this._view.render(),this._initMarketPanel(),this._initPortfolioPanel(),r.on("portfoliosModifiedEv",this._rerenderAllPortfoliosIfNeeded.bind(this))},_initMarketPanel:function(){this._marketPanel=new n(this._view.getMarketWrapper()),this._marketPanel.render()},_initPortfolioPanel:function(){this._portfolioPanel=new s(this._view.getPortfolioWrapper()),this._portfolioPanel.render(),this._portfolioPanel.on("rerenderPortfoliosEv",this._rerenderAllPortfolios.bind(this))},_rerenderAllPortfoliosIfNeeded:function(t,e){var i=this._portfolioPanel.numberOfVisiblePortfoliosChanged(t);i&&(1===i?this._portfolioPanel.rerenderPortfolio(t[0],e,!0):this._rerenderAllPortfolios(t,!0)),this._marketPanel.rerenderOnPortfoliosUpdate(t,e)},_rerenderAllPortfolios:function(t,e){var i=this;o.Render.Portfolios().then(function(t){return i._view.rerenderPortfolios(t,e)}).then(function(){return i._portfolioPanel.initPortfolioWrappers(t)})}})});